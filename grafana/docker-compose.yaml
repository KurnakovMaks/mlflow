version: '3'
services:
  # Prometheus работает в обычном режиме + пишет копию в VM
  prometheus:
    image: prom/prometheus:v3.5.0
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=8h"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - monitoring-net
    restart: unless-stopped

  promtail:
    image: grafana/promtail:3.5.3
    user: root
    volumes:
      - ./promtail-config.yml:/etc/promtail/config.yml
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Fixed path
    networks:
      - monitoring-net
    depends_on:
      - loki
    restart: unless-stopped

  # VictoriaMetrics работает ТОЛЬКО как удаленное хранилище
  victoria-metrics:
    image: victoriametrics/victoria-metrics:v1.124.0
    command:
      - -retentionPeriod=1d  # Храним данные 1 день
      - -httpListenAddr=:8428
      - -selfScrapeInstance=victoria-metrics:8428
      - -search.cacheTimestampOffset=10m  # Increase from 5m to 10m
      - -search.maxConcurrentRequests=8  # Уменьшаем concurrent-запросы


    ports:
      - "8428:8428"
    volumes:
      - victoria-data:/storage
    networks:
      - monitoring-net
    restart: unless-stopped

  grafana:
    image: grafana/grafana:12.1.1
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
    networks:
      - monitoring-net
    depends_on:
      - prometheus
      - loki
    restart: unless-stopped

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.52.0
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    ports:
      - "8080:8080"
    networks:
      - monitoring-net
    restart: unless-stopped

  loki:
    image: grafana/loki:3.5.3
    ports:
      - "3100:3100"
    volumes:
      - ./loki-config.yml:/etc/loki/local-config.yml
      - loki-data:/loki
    networks:
      - monitoring-net
    restart: unless-stopped

volumes:
  victoria-data:
  prometheus-data:
  grafana-data:
  loki-data:

networks:
  monitoring-net:
    name: monitoring-net
    driver: bridge